<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Paradigms - traj infra upgrade</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../css/highlight.css">
  <link href="../extra.css" rel="stylesheet">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Paradigms";
    var mkdocs_page_input_path = "paradigms.md";
    var mkdocs_page_url = "/paradigms/";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js"></script>
  <script src="../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../js/highlight.pack.js"></script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> traj infra upgrade</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="..">Home</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../fundamentals/">Fundamentals</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 current">
        <a class="current" href="./">Paradigms</a>
        
            <ul>
            
                <li class="toctree-l3"><a href="#load-both-cms-file-and-trajectory">load both cms file and trajectory</a></li>
                
            
                <li class="toctree-l3"><a href="#extract-structure-once-and-per-frame-update-coordinates-instead-of-per-frame-update-full-system-ct-and-extract-structure">extract structure once and per frame update coordinates instead of per frame update full system ct and extract structure</a></li>
                
            
                <li class="toctree-l3"><a href="#try-avoid-unwrap-coordinates-around-periodic-boundary-conditions-yourself">try avoid unwrap coordinates around periodic boundary conditions yourself</a></li>
                
            
                <li class="toctree-l3"><a href="#analyze-all-together-instead-of-one-by-one">analyze all together instead of one by one</a></li>
                
            
                <li class="toctree-l3"><a href="#testing">testing</a></li>
                
            
            </ul>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../correspondence/">Correspondence</a>
        
    </li>
<li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">traj infra upgrade</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>Paradigms</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h2 id="load-both-cms-file-and-trajectory">load both cms file and trajectory</h2>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">schrodinger.application.desmond.packages.topo</span> <span class="kn">as</span> <span class="nn">topo</span>
<span class="kn">import</span> <span class="nn">schrodinger.application.desmond.packages.traj</span> <span class="kn">as</span> <span class="nn">traj</span>

<span class="n">msys_model</span><span class="p">,</span> <span class="n">cms_model</span> <span class="o">=</span> <span class="n">topo</span><span class="o">.</span><span class="n">read_cms</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">cms_file</span><span class="p">)</span>
<span class="n">trj_path</span> <span class="o">=</span> <span class="n">topo</span><span class="o">.</span><span class="n">find_traj_path</span><span class="p">(</span><span class="n">cms_model</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">cms_file</span><span class="p">))</span>
<span class="k">if</span> <span class="n">trj_path</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Could not locate a trajectory directory for given CMS file&#39;</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">trj</span> <span class="o">=</span> <span class="n">traj</span><span class="o">.</span><span class="n">read_traj</span><span class="p">(</span><span class="n">trj_path</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Cannot load trajectory file: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
</pre></div>


<h2 id="extract-structure-once-and-per-frame-update-coordinates-instead-of-per-frame-update-full-system-ct-and-extract-structure">extract structure once and per frame update coordinates instead of per frame update full system ct and extract structure</h2>
<p>Note that although one can get the full system ct per frame in new trajectory infrastructure, it is likely the inefficient approach.
In most cases, the user does not need to track the full system ct over the frames.
Instead, only specific group of atoms or molecules needs to be tracked over the frames.
In these situations, it is more efficient to</p>
<ul>
<li>extract the atoms of molecules into a structure once</li>
<li>keep updating (or maybe only read) the coordinates of the selected atoms or molecules frame by frame</li>
</ul>
<p>If the analysis is fully geometric, then the structure extraction can be avoided as well.</p>
<p>Here is an example</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">schrodinger.application.desmond.packages.topo</span> <span class="kn">as</span> <span class="nn">topo</span>
<span class="kn">import</span> <span class="nn">schrodinger.application.desmond.packages.traj</span> <span class="kn">as</span> <span class="nn">traj</span>

<span class="n">_</span><span class="p">,</span> <span class="n">cms_model</span> <span class="o">=</span> <span class="n">topo</span><span class="o">.</span><span class="n">read_cms</span><span class="p">(</span><span class="n">cms_filename</span><span class="p">)</span>
<span class="n">tr</span> <span class="o">=</span> <span class="n">traj</span><span class="o">.</span><span class="n">read_traj</span><span class="p">(</span><span class="n">trajectory_directory</span><span class="p">)</span>
<span class="n">protein_aids</span> <span class="o">=</span> <span class="n">cms_model</span><span class="o">.</span><span class="n">select_atom</span><span class="p">(</span><span class="n">protein_asl</span><span class="p">)</span>
<span class="n">protein_gids</span> <span class="o">=</span> <span class="n">topo</span><span class="o">.</span><span class="n">aids2gids</span><span class="p">(</span><span class="n">cms_model</span><span class="p">,</span> <span class="n">protein_aids</span><span class="p">,</span>
                              <span class="n">include_pseudoatoms</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">protein_st</span> <span class="o">=</span> <span class="n">cms_model</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">protein_aids</span><span class="p">)</span>
<span class="k">for</span> <span class="n">fr</span> <span class="ow">in</span> <span class="n">tr</span><span class="p">:</span>
    <span class="n">protein_st</span><span class="o">.</span><span class="n">setXYZ</span><span class="p">(</span><span class="n">fr</span><span class="o">.</span><span class="n">pos</span><span class="p">(</span><span class="n">protein_gids</span><span class="p">))</span>
    <span class="c1"># what needs to be done on the protein structure</span>
    <span class="o">...</span>
</pre></div>


<p>This is better than</p>
<div class="highlight"><pre><span></span><span class="n">_</span><span class="p">,</span> <span class="n">cms_model</span> <span class="o">=</span> <span class="n">topo</span><span class="o">.</span><span class="n">read_cms</span><span class="p">(</span><span class="n">cms_filename</span><span class="p">)</span>
<span class="n">tr</span> <span class="o">=</span> <span class="n">traj</span><span class="o">.</span><span class="n">read_traj</span><span class="p">(</span><span class="n">trajectory_directory</span><span class="p">)</span>
<span class="n">protein_aids</span> <span class="o">=</span> <span class="n">cms_model</span><span class="o">.</span><span class="n">select_atom</span><span class="p">(</span><span class="n">protein_asl</span><span class="p">)</span>
<span class="k">for</span> <span class="n">fr</span> <span class="ow">in</span> <span class="n">tr</span><span class="p">:</span>
    <span class="n">updated_cms</span> <span class="o">=</span> <span class="n">topo</span><span class="o">.</span><span class="n">update_fsys_ct</span><span class="p">(</span><span class="n">cms_model</span><span class="p">,</span> <span class="n">fr</span><span class="p">)</span>
    <span class="n">protein_st</span> <span class="o">=</span> <span class="n">updated_cms</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">protein_aids</span><span class="p">)</span>
    <span class="c1"># what needs to be done on the protein structure</span>
    <span class="o">...</span>
</pre></div>


<h2 id="try-avoid-unwrap-coordinates-around-periodic-boundary-conditions-yourself">try avoid unwrap coordinates around periodic boundary conditions yourself</h2>
<p>There are mechanisms in the new trajectory infrastructure to do these unwrapping for you. The relevant analyzer classes are</p>
<ul>
<li>basic geometric operations<ul>
<li><code>Angle</code></li>
<li><code>Distance</code></li>
<li><code>Torsion</code></li>
<li><code>Vector</code></li>
</ul>
</li>
<li><code>CenterOf</code><ul>
<li><code>Centroid</code></li>
<li><code>CoC</code>: center of charge</li>
<li><code>Com</code>: center of mass</li>
</ul>
</li>
</ul>
<p>You can even measure geometric quantity between (among) center of mass objects/atoms (see example below), etc.</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">schrodinger.application.desmond.packages</span> <span class="kn">import</span> <span class="n">analysis</span>
<span class="kn">from</span> <span class="nn">schrodinger.application.desmond.packages</span> <span class="kn">import</span> <span class="n">traj</span>
<span class="kn">from</span> <span class="nn">schrodinger.application.desmond.packages</span> <span class="kn">import</span> <span class="n">topo</span>

<span class="c1"># load data</span>
<span class="n">msys_model</span><span class="p">,</span> <span class="n">cms_model</span> <span class="o">=</span> <span class="n">topo</span><span class="o">.</span><span class="n">read_cms</span><span class="p">(</span><span class="n">FNAME</span><span class="p">)</span>
<span class="n">tr</span> <span class="o">=</span> <span class="n">traj</span><span class="o">.</span><span class="n">read_traj</span><span class="p">(</span><span class="n">TRJ_FNAME</span><span class="p">)</span>

<span class="c1"># define analyzers</span>
<span class="n">analyzer1</span> <span class="o">=</span> <span class="n">analysis</span><span class="o">.</span><span class="n">Com</span><span class="p">(</span><span class="n">msys_model</span><span class="p">,</span> <span class="n">cms_model</span><span class="p">,</span> <span class="n">asl</span><span class="o">=</span><span class="n">my_asl</span><span class="p">)</span>
<span class="n">ana_vector</span> <span class="o">=</span> <span class="n">analysis</span><span class="o">.</span><span class="n">Vector</span><span class="p">(</span><span class="n">msys_model</span><span class="p">,</span> <span class="n">cms_model</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">analyzer3</span> <span class="o">=</span> <span class="n">analysis</span><span class="o">.</span><span class="n">ProtLigInter</span><span class="p">(</span><span class="n">msys_model</span><span class="p">,</span> <span class="n">cms_model</span><span class="p">,</span> <span class="s1">&#39;protein&#39;</span><span class="p">,</span> <span class="s1">&#39;m.n 2&#39;</span><span class="p">)</span>
<span class="n">s5</span> <span class="o">=</span> <span class="n">analysis</span><span class="o">.</span><span class="n">Com</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">msys_model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cms_model</span><span class="p">,</span> <span class="n">asl</span><span class="o">=</span><span class="s1">&#39;not atom.num 17&#39;</span><span class="p">)</span>  <span class="c1"># this doesn&#39;t need to be passed to analysis.analyze</span>
<span class="n">dist_com_atm</span> <span class="o">=</span> <span class="n">analysis</span><span class="o">.</span><span class="n">Distance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">msys_model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cms_model</span><span class="p">,</span> <span class="n">s5</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

<span class="c1"># compute result</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">analysis</span><span class="o">.</span><span class="n">analyze</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="n">analyzer1</span><span class="p">,</span> <span class="n">ana_vector</span><span class="p">,</span> <span class="n">analyzer3</span><span class="p">,</span> <span class="n">dist_com_atm</span><span class="p">)</span>
</pre></div>


<p>If you have to unwrap yourself, use the <code>analysis.Pbc</code> class. Also note that the simulation box may change from frame to frame, e.g. in NPT systems. Thus the <code>analysis.Pbc</code> object needs to be updated frame by frame.</p>
<p>Note that the <a href="https://en.wikipedia.org/wiki/Center_of_mass#Systems_with_periodic_boundary_conditions">circular mean algorithm</a> is used to calculate geometric centers.
Thus it will fail if both of the following conditions apply
* the selected atoms have a spatial extent comparable to the simulation box
* the selected atoms do not form a blob-like shape (e.g., dumbbell)</p>
<h2 id="analyze-all-together-instead-of-one-by-one">analyze all together instead of one by one</h2>
<p>If multiple analyzers can share some intermediate calculations, 
there is a good chance that the new trajectory analysis framework calculates these intermediate results only once.
Thus it is more efficient to call <code>analysis.analyze</code> with all analyzers together instead of calling <code>analysis.analyze</code> multiple times.</p>
<p>Thus
<div class="highlight"><pre><span></span><span class="n">results</span> <span class="o">=</span> <span class="n">analysis</span><span class="o">.</span><span class="n">analyze</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="n">analyzer1</span><span class="p">,</span> <span class="n">analyzer2</span><span class="p">,</span> <span class="n">analyzer3</span><span class="p">)</span>
</pre></div>
</p>
<p>is better than
<div class="highlight"><pre><span></span><span class="n">result1</span> <span class="o">=</span> <span class="n">analysis</span><span class="o">.</span><span class="n">analyze</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="n">analyzer1</span><span class="p">)</span>
<span class="n">result2</span> <span class="o">=</span> <span class="n">analysis</span><span class="o">.</span><span class="n">analyze</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="n">analyzer2</span><span class="p">)</span>
<span class="n">result3</span> <span class="o">=</span> <span class="n">analysis</span><span class="o">.</span><span class="n">analyze</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="n">analyzer3</span><span class="p">)</span>
</pre></div>
</p>
<h2 id="testing">testing</h2>
<p>The new trajectory modules are in the desmond package.
Thus if you are working on a non-desmond repo and uses trajectory stuff, test has to be written in the following way</p>
<ul>
<li>use <code>test_marker.require_product('desmond')</code></li>
<li>lazy import the trajectory handling modules</li>
</ul>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pytest</span>

<span class="c1"># Lazy import, in case desmond is not installed</span>
<span class="n">mf</span> <span class="o">=</span> <span class="bp">None</span>

<span class="nd">@pytest.fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;module&#39;</span><span class="p">,</span> <span class="n">autouse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">import_my_file</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">mf</span>
    <span class="kn">import</span> <span class="nn">my_file</span> <span class="kn">as</span> <span class="nn">mf</span>
</pre></div>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../correspondence/" class="btn btn-neutral float-right" title="Correspondence">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../fundamentals/" class="btn btn-neutral" title="Fundamentals"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>
    
  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../fundamentals/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../correspondence/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script src="../js/theme.js"></script>

</body>
</html>
